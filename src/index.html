<!DOCTYPE html>
<!--
    Created by: [@thepurplelemons](https://github.com/purplelemons-dev)
    For: Collin College Police Department
    License: GNU General Public License v3.0
-->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Generator</title>
    <script src="https://unpkg.com/docxtemplater"></script>
    <script src="https://unpkg.com/xlsx"></script>
</head>

<body>
    <form>
        <label for="data">Excel file</label>
        <input type="file" accept=".xlsx, .xls" name="sheet" id="data">
        <br><br>
        <label for="template">Template</label>
        <input type="file" accept=".docx" name="template" id="template">
        <br><br>
    </form>
</body>
<script>
    const data = document.getElementById('data');
    const template = document.getElementById('template');
    let [dataLoaded, tempLoaded] = [false, false];
    data.addEventListener('change', async (e) => {
        dataLoaded = true;
        if (tempLoaded) {
            await fillForm(data, template);
        }
    });
    template.addEventListener('change', async (e) => {
        tempLoaded = true;
        if (dataLoaded) {
            await fillForm(data, template);
        }
    });

    /**
     * @param {HTMLInputElement} data
     * @param {HTMLInputElement} template
     */
    const fillForm = async (data, template) => {
        console.log(`Data: ${data.files[0].name}\nTemplate: ${template.files[0].name}`);
        const reportName = data.files[0].name.split('.')[0];

        const workbook = await XLSX.readFile(await data.files[0].arrayBuffer(), { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const sheetData = XLSX.utils.sheet_to_json(sheet);
        console.log(sheetData);
        let rowCounter = 1;

        for (const row of sheetData) {
            console.log(row);



            const downloader = document.createElement('button');
            downloader.innerText = `Download Row ${rowCounter}`;
            downloader.addEventListener('click', async () => {

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportName}_${rowCounter++}.pdf`;
                a.click();
            });
            document.body.appendChild(downloader);
        }

    }
</script>

</html>